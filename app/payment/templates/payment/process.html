{% extends 'base.html' %}
{% load static %}

{% block title %}Оплата заказа{% endblock title %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'deps/css/payment_process.css' %}">
{% endblock %}


{% block content %}
<div class="window">
    <h2 class="pay-title">Оплата заказа</h2>

    <div class="pay-card d-flex">
        <!-- Корзина -->
        <div class="cart-cardsproc">
            {% for item in order.items.all %}
                {% with product=item.product %}
                    <div class="cart-card d-flex">
                        <div class="cart-card-img">
                            <img src="{% if product.image %}{{ product.image.url }}{% endif %}" 
                            class="process-img" alt="{{ product.name }}">
                        </div>
                        <div class="cart-card-info">
                            <div class="cart-card-name">
                                <p>{{ product.name }}</p>
                            </div>
                            <div class="cart-card-q">
                                <p>Количество: <span>{{ item.quantity }}</span></p>
                            </div>
                        </div>
                        <div class="cart-card price">
                            {% if product.discount %}
                                <div class="cart-price">
                                    <p class="line opas">$ {{ product.price }}</p>
                                    <p class="cart-total-price-ots">$ <span>{{ product.sell_price }}</span></p>
                                </div>
                            {% else %}
                                <p class="cart-total-price">$ <span>{{ product.price }}</span></p>
                            {% endif %}
                        </div>
                    </div>
                {% endwith %}
            {% endfor %}

            <p class="cart-total">Итого: $ <span>{{ order.get_total_cost }}</span></p>

            <!-- Выбор способа оплаты -->
            <h3>Выберите способ оплаты:</h3>
            <div class="payment-options">
                <label><input type="radio" name="payment_method" value="stripe" checked> Stripe (картой онлайн)</label><br>
                <label><input type="radio" name="payment_method" value="unitpay"> UnitPay</label><br>
                <label><input type="radio" name="payment_method" value="idram"> Idram</label><br>
            </div>

            <button type="button" id="pay-button" class="paynow">Оплатить</button>
        </div>

        {% comment %} <!-- Картинка справа -->
        <div class="castle-div">
            <img src="{% static 'img/castle.png' %}" alt="castle" class="castlep">
        </div> {% endcomment %}
    </div>
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
document.getElementById('pay-button').addEventListener('click', function() {
    const method = document.querySelector('input[name="payment_method"]:checked').value;
    const orderId = '{{ order.id }}';

    if (method === 'stripe') {
        fetch("{% url 'payment:create_checkout_session' %}", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({order_id: orderId})
        })
        .then(res => res.json())
        .then(session => Stripe("{{ stripe_public_key }}").redirectToCheckout({ sessionId: session.id }))
        .catch(err => console.error(err));

    } else if (method === 'unitpay') {
        window.location.href = "{% url 'payment:unitpay_start' order.id %}";

    } else if (method === 'idram') {
        window.location.href = "{% url 'payment:idram_start' order.id %}";

    }
});
fetch("{% url 'payment:create_checkout_session' %}", {
    method: "POST",
    headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": "{{ csrf_token }}"
    },
    body: JSON.stringify({ order_id: orderId })
});
</script>
{% endblock content %}


{% block footer %}{% endblock  %}

{% comment %} {% extends 'base.html' %}
{% load static %}


{% block title %}Payment process{% endblock title %}

{% block content %}
    <div class="window">
        <h2 class="pay-title">Payment</h2>

        <script>
          var stripe = Stripe("{{ stripe_public_key }}");
          document.getElementById("checkout-button").addEventListener("click", function () {
            fetch("/create-checkout-session/", {
              method: "POST",
            })
            .then(response => response.json())
            .then(session => stripe.redirectToCheckout({ sessionId: session.id }))
            .catch(error => console.error("Error:", error));
          });
        </script>
        <div class="pay-card d-flex">
            <div class="cart-cardsproc">
                {% for item in orders.items.all %}
                    {% with product=item.product %}
                        <div class="cart-card d-flex">
                            <div class="cart-card-img">
                                <img src="{% if product.image %}{{ product.image.url }}{% endif %}" alt="{{ product.name }}">
                            </div>
                            <div class="cart-card-info">
                                <div class="cart-card-name">
                                    <p>{{ product.name}}</p>
                                </div>
                                <div class="cart-card-q">
                                    <p>Quantity: {{ item.quantity}}</p>
                                </div>
                            </div>
                            <form action="{% url 'cart:cart_remove' product.id %}" method="post">
                               <input type="submit" value="Remove" class="remove-btn">
                               {% csrf_token %}
                            </form>
                            <div class="cart-card price">
                                {% if product.discount %}
                                    <div class="cart-price">
                                        <p class="line opas">$ {{product.price}}</p>
                                        <p class="cart-total-price-ots">$ {{product.sell_price}}</p>
                                    </div>
                                {% else %}
                                    <p class="cart-total-price">$ {{product.price}}</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endwith %}
                {% endfor %}

                <form action="{% url 'payment:process' order.id  %}" class="payform" method="post">
                    <input type="submit" value="Pay now" class="paynow">
                    {% csrf_token %}
                </form>
            </div>
            <div class="castle-div">
                <img src="{% static 'img/castle.png' %}" alt="castle" class="castlep">
            </div>
        </div>
    </div>
{% endblock content %} {% endcomment %}